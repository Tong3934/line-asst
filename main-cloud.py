"""
LINE Bot р╕кр╕│р╕лр╕гр╕▒р╕Ър╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Бр╕▓р╕гр╣Ар╕Др╕ер╕бр╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕гр╕Цр╕вр╕Щр╕Хр╣М
р╣Гр╕Кр╣Й FastAPI + LINE Messaging API + Google Gemini AI
"""

import os
import io
import json
import base64
import tempfile
import time
import re
from typing import Dict, Optional
from dotenv import load_dotenv
from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import JSONResponse
from linebot.v3 import WebhookHandler
from linebot.v3.exceptions import InvalidSignatureError
from linebot.v3.messaging import (
    Configuration,
    ApiClient,
    MessagingApi,
    ReplyMessageRequest,
    PushMessageRequest,
    TextMessage,
    ImageMessage,
    FlexMessage,
    FlexContainer,
    QuickReply,        # р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕╕р╣Ир╕бр╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б
    QuickReplyItem,    # р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕╕р╣Ир╕бр╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б
    MessageAction      # р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕╕р╣Ир╕бр╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б
)
from linebot.v3.webhooks import (
    MessageEvent,
    TextMessageContent,
    ImageMessageContent
)
import google.generativeai as genai
import httpx

# Import Mock Data
from mock_data import get_policy_info

# Import Flex Messages
from flex_messages import create_request_info_flex, create_policy_info_flex, create_analysis_result_flex

import ssl
ssl._create_default_https_context = ssl._create_unverified_context

# р╣Вр╕лр╕ер╕Ф environment variables
load_dotenv()

# р╕Фр╕╢р╕Зр╕Др╣Ир╕▓р╕Ир╕▓р╕Б .env
LINE_CHANNEL_ACCESS_TOKEN = os.getenv('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.getenv('LINE_CHANNEL_SECRET')
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╣Ир╕▓
if not all([LINE_CHANNEL_ACCESS_TOKEN, LINE_CHANNEL_SECRET, GEMINI_API_KEY]):
    raise ValueError("тЭМ р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Environment Variables р╣Гр╕Щр╣Др╕Яр╕ер╣М .env р╣Гр╕лр╣Йр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ")

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ LINE Bot
configuration = Configuration(access_token=LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Gemini AI
genai.configure(api_key=GEMINI_API_KEY)
# р╣Гр╕Кр╣Йр╕Кр╕╖р╣Ир╕нр╕гр╕╕р╣Ир╕Щр╕бр╕▓р╕Хр╕гр╕Рр╕▓р╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Бр╕▒р╕Ъ API р╕Чр╕╕р╕Бр╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕Щ
# gemini_model = genai.GenerativeModel(model_name='models/gemini-1.5-flash')
gemini_model = genai.GenerativeModel(model_name='models/gemini-2.5-flash')

# р╕кр╕гр╣Йр╕▓р╕З FastAPI App
app = FastAPI(title="LINE Insurance Claim Bot")

# Dictionary р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Бр╣Зр╕Ъ Session р╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Бр╕Хр╣Ир╕ер╕░р╕Др╕Щ
# Structure: {user_id: {"state": "...", "name": "...", "plate": "...", "policy_info": {...}}}
user_sessions: Dict[str, Dict] = {}


# ==================== Helper Functions ====================
def extract_phone_from_response(text: str) -> Optional[str]:
    """
    р╕Фр╕╢р╕Зр╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕гр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б AI
    р╕гр╕нр╕Зр╕гр╕▒р╕Ър╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ:
    - р╣Вр╕Чр╕г 1557
    - р╣Вр╕Чр╕г 02-123-4567
    - р╣Ар╕Ър╕нр╕гр╣М: 098-765-4321
    - р╣Вр╕Чр╕гр╕ир╕▒р╕Юр╕Чр╣М: 1234567890
    
    Returns:
        р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕гр╕Чр╕╡р╣Ир╣Ар╕нр╕▓ - р╣Бр╕ер╕░р╕Кр╣Ир╕нр╕Зр╕зр╣Ир╕▓р╕Зр╕нр╕нр╕Б р╕лр╕гр╕╖р╕н None р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Юр╕Ъ
    """
    patterns = [
        r'р╣Вр╕Чр╕г\s*(\d{4})',                          # р╣Вр╕Чр╕г 1557
        r'р╣Вр╕Чр╕г\s*(\d{2,3}[-\s]?\d{3}[-\s]?\d{4})',  # р╣Вр╕Чр╕г 02-123-4567
        r'р╣Ар╕Ър╕нр╕гр╣М[:\s]*(\d{2,3}[-\s]?\d{3}[-\s]?\d{4})',  # р╣Ар╕Ър╕нр╕гр╣М: 098-765-4321
        r'р╣Вр╕Чр╕гр╕ир╕▒р╕Юр╕Чр╣М[:\s]*(\d{2,3}[-\s]?\d{3}[-\s]?\d{4})',  # р╣Вр╕Чр╕гр╕ир╕▒р╕Юр╕Чр╣М: 02-123-4567
        r'р╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕[:\s]*(\d{4})',                 # р╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕ 1557
        r'(?:р╣Вр╕Чр╕г|р╣Ар╕Ър╕нр╕гр╣М)\s*[:я╝Ъ]?\s*(\d{10})',     # р╣Вр╕Чр╕г: 0987654321
    ]
    
    for pattern in patterns:
        match = re.search(pattern, text)
        if match:
            phone = match.group(1).replace('-', '').replace(' ', '')
            return phone
    
    return None


# ==================== Gemini AI Analysis ====================
def analyze_damage_with_gemini(
    image_bytes: bytes, 
    policy_info: Dict, 
    additional_info: Optional[str] = None,
    has_counterpart: Optional[str] = None
) -> str:
    """
    р╣Гр╕Кр╣Й Gemini AI р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╕Юр╕гр╣Йр╕нр╕бр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╕Ир╕гр╕┤р╕З

    Args:
        image_bytes: р╕Вр╣Йр╕нр╕бр╕╣р╕е bytes р╕Вр╕нр╕Зр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕в
        policy_info: р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М (р╕гр╕зр╕бр╣Ар╕нр╕Бр╕кр╕▓р╕г Base64)
        additional_info: р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕бр╕Ир╕▓р╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓ (р╕Цр╣Йр╕▓р╕бр╕╡)
        has_counterpart: р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡ ("р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡" р╕лр╕гр╕╖р╕н "р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡")

    Returns:
        р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ьр╕ер╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Ир╕▓р╕Б AI
    """
    try:
        # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
        has_policy_document = policy_info.get('policy_document_base64') is not None
        
        # р╕кр╕гр╣Йр╕▓р╕З System Prompt р╣Гр╕лр╣Й AI р╕нр╣Ир╕▓р╕Щр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Ир╕гр╕┤р╕З
        if has_policy_document:
          system_prompt = f"""
          р╕Др╕╕р╕Ур╕Др╕╖р╕н "AI р╕Ьр╕╣р╣Йр╣Ар╕Кр╕╡р╣Ир╕вр╕зр╕Кр╕▓р╕Нр╕Фр╣Йр╕▓р╕Щр╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕гр╕Цр╕вр╕Щр╕Хр╣Мр╣Бр╕ер╕░р╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╕кр╕┤р╕Щр╣Др╕лр╕б" р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ър╕гр╕┤р╕Бр╕▓р╕г "р╣Ар╕Кр╣Зр╕Др╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕бр╕Фр╣Ир╕зр╕Щ"
            р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Фр╣Йр╕зр╕вр╕бр╕▓р╕Хр╕гр╕Рр╕▓р╕Щр╕гр╕░р╕Фр╕▒р╕Ър╕бр╕╖р╕нр╕нр╕▓р╕Кр╕╡р╕Ю р╣Бр╕бр╣Ир╕Щр╕вр╕│р╕Хр╕▓р╕бр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М р╣Бр╕ер╕░р╕кр╕╖р╣Ир╕нр╕кр╕▓р╕гр╕нр╕вр╣Ир╕▓р╕Зр╕гр╕зр╕Фр╣Ар╕гр╣Зр╕зр╣Ар╕Ыр╣Зр╕Щр╕Бр╕▒р╕Щр╣Ар╕нр╕З

            **р╕ар╕▓р╕гр╕Бр╕┤р╕Ир╕Вр╕нр╕Зр╕Др╕╕р╕У:**
            р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕ар╕▓р╕Юр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕в (р╕ар╕▓р╕Юр╕Чр╕╡р╣И 1) р╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ър╕Бр╕▒р╕Ър╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М (р╕ар╕▓р╕Юр╕Чр╕╡р╣И 2/PDF) р╕нр╕вр╣Ир╕▓р╕Зр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Бр╕ер╕░р╕гр╕зр╕Фр╣Ар╕гр╣Зр╕з р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕Чр╕╡р╣Ир╕кр╕╕р╕Фр╣Бр╕Бр╣Ир╕Ьр╕╣р╣Йр╣Ар╕нр╕▓р╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕ар╕▒р╕в

          **р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щр╕ер╕╣р╕Бр╕Др╣Йр╕▓:**
          - р╕Ьр╕╣р╣Йр╣Ар╕нр╕▓р╕Ыр╕гр╕░р╕Бр╕▒р╕Щ: р╕Др╕╕р╕У {policy_info['first_name'].strip()} {policy_info['last_name']}
          - р╕гр╕Цр╕вр╕Щр╕Хр╣М: {policy_info['car_model']} ({policy_info['car_year']}) р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щ {policy_info['plate']}
          - р╕Ър╕гр╕┤р╕йр╕▒р╕Чр╕Ыр╕гр╕░р╕Бр╕▒р╕Щ: {policy_info['insurance_company']}"""
          
          # р╣Ар╕Юр╕┤р╣Ир╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕Цр╕▓р╕Щр╕░р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╕Ир╕▓р╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓
          if has_counterpart:
              if has_counterpart == "р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡":
                  system_prompt += f"""
          - р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡: тЬЕ **р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡** (р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕вр╕╖р╕Щр╕вр╕▒р╕Щ)
          
          тЪая╕П **р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕кр╕│р╕лр╕гр╕▒р╕Ъ AI:**
          - р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕зр╣Ир╕▓ "р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡"
          - р╣Гр╕лр╣Йр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Гр╕Щр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕зр╣Ир╕▓р╕бр╕╡р╕лр╕ер╕▒р╕Бр╕Рр╕▓р╕Щр╕гр╕Цр╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
          - р╕Цр╣Йр╕▓р╣Гр╕Щр╕гр╕╣р╕Ыр╣Др╕бр╣Ир╣Ар╕лр╣Зр╕Щр╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ тЖТ р╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╣Ар╕Юр╕┤р╣Ир╕б
          - р╕Цр╣Йр╕▓р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╕Ир╕гр╕┤р╕З тЖТ р╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕Кр╕▒р╣Йр╕Щ 2+/2/3+/3 р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Др╕ер╕бр╣Др╕Фр╣Й
          - р╕Кр╕▒р╣Йр╕Щ 1 тЖТ р╣Ар╕Др╕ер╕бр╣Др╕Фр╣Йр╕Чр╕╕р╕Бр╕Бр╕гр╕Ур╕╡ (р╣Др╕бр╣Ир╕зр╣Ир╕▓р╕Ир╕░р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╕лр╕гр╕╖р╕нр╣Др╕бр╣И)"""
              
              elif has_counterpart == "р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡":
                  system_prompt += f"""
          - р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡: тЭМ **р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡** (р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕вр╕╖р╕Щр╕вр╕▒р╕Щ - р╕Кр╕Щр╣Ар╕кр╕▓/р╣Ар╕Йр╕╡р╣Ир╕вр╕зр╕Кр╕Щр╣Ар╕нр╕З)
          
          тЪая╕П **р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕кр╕│р╕лр╕гр╕▒р╕Ъ AI:**
          - р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕зр╣Ир╕▓ "р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡" (р╕Кр╕Щр╣Ар╕кр╕▓, р╣Ар╕Йр╕╡р╣Ир╕вр╕зр╕Кр╕Щр╕зр╕▒р╕Хр╕Цр╕╕, р╕Кр╕Щр╕Бр╕│р╣Бр╕Юр╕З)
          - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕Ир╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕г:
            тАв р╕Кр╕▒р╣Йр╕Щ 1 тЖТ тЬЕ р╣Ар╕Др╕ер╕бр╣Др╕Фр╣Й (р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡)
            тАв р╕Кр╕▒р╣Йр╕Щ 2+/2/3+/3 тЖТ тЭМ р╣Ар╕Др╕ер╕бр╣Др╕бр╣Ир╣Др╕Фр╣Й (р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╣Ар╕Ыр╣Зр╕Щр╕вр╕▓р╕Щр╕Юр╕▓р╕лр╕Щр╕░)
          - р╕Цр╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щр╕Кр╕▒р╣Йр╕Щ 2+ тЖТ р╣Бр╕Ир╣Йр╕Зр╕Кр╕▒р╕Фр╣Ар╕Ир╕Щр╕зр╣Ир╕▓ "р╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕б" р╕Юр╕гр╣Йр╕нр╕бр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Ир╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕г"""
          
          # р╣Ар╕Юр╕┤р╣Ир╕бр╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕бр╕Ир╕▓р╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓ (р╕Цр╣Йр╕▓р╕бр╕╡)
          if additional_info:
              system_prompt += f"""
          - р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Ир╕▓р╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓: "{additional_info}"
          
          тЪая╕П **р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕:** р╣Гр╕Кр╣Йр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕╡р╣Йр╕Ыр╕гр╕░р╕Бр╕нр╕Ър╕Бр╕▓р╕гр╕Юр╕┤р╕Ир╕▓р╕гр╕Ур╕▓ р╣Бр╕Хр╣Ир╕вр╕╢р╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Бр╕ер╕░р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╣Ар╕Ыр╣Зр╕Щр╕лр╕ер╕▒р╕Б"""
          
          system_prompt += """

          тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
          **ЁЯОп р╕Бр╕Ор╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Ар╕Кр╕┤р╕Зр╕ер╕╢р╕Б (CRITICAL RULES):**
          тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
          1. **CITATION (р╕Хр╣Йр╕нр╕Зр╕Чр╕│):** р╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣Ир╕гр╕░р╕Ър╕╕р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Ыр╕гр╕░р╕Бр╕▒р╕Щ р╕Хр╣Йр╕нр╕Зр╣Гр╕кр╣Ир╣Ар╕ер╕Вр╕Ър╕гр╕гр╕Чр╕▒р╕Фр╕лр╕гр╕╖р╕нр╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Ир╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕г р╣Ар╕Кр╣Ир╕Щ [р╕лр╕Щр╣Йр╕▓ 1: р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Ыр╕гр╕░р╕Бр╕▒р╕Щ], [р╕лр╕Щр╣Йр╕▓ 1: р╕Др╣Ир╕▓р╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╕кр╣Ир╕зр╕Щр╣Бр╕гр╕Б]
          2. **AI LOGIC:** - р╕Цр╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щр╕Кр╕▒р╣Йр╕Щ 2+ р╕лр╕гр╕╖р╕н 3+: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕Вр╣Йр╕бр╕Зр╕зр╕Фр╕зр╣Ир╕▓р╕гр╕нр╕вр╣Гр╕Щр╕ар╕▓р╕Ю "р╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕гр╕Кр╕Щр╕Бр╕▒р╕Ър╕вр╕▓р╕Щр╕Юр╕▓р╕лр╕Щр╕░" р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
            - р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У: р╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ъ "р╕Др╣Ир╕▓р╕Лр╣Ир╕нр╕бр╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щ" vs "р╕Др╣Ир╕▓ Excess" р╣Гр╕Щр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Ир╕гр╕┤р╕Зр╣Ар╕кр╕бр╕н

          тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
          **ЁЯУж р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Бр╕▓р╕гр╕Хр╕нр╕Ъ (р╕кр╕│р╕лр╕гр╕▒р╕Ъ "р╣Ар╕Кр╣Зр╕Др╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕бр╕Фр╣Ир╕зр╕Щ"):**
          тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ

          р╕кр╕зр╕▒р╕кр╕Фр╕╡р╕Др╕гр╕▒р╕Ъ р╕Др╕╕р╕У {policy_info['first_name'].strip()} р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Бр╕▓р╕гр╣Ар╕Кр╣Зр╕Др╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕бр╕Фр╣Ир╕зр╕Щр╕Фр╕▒р╕Зр╕Щр╕╡р╣Йр╕Др╕гр╕▒р╕Ъ:

          ЁЯУД **р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╕Ир╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕г**
          тАв р╕Ыр╕гр╕░р╣Ар╕ар╕Ч: [р╕гр╕░р╕Ър╕╕ р╣Ар╕Кр╣Ир╕Щ р╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕Кр╕▒р╣Йр╕Щ 2+] [р╕лр╕Щр╣Йр╕▓ 1]
          тАв р╕Др╣Ир╕▓р╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╕кр╣Ир╕зр╕Щр╣Бр╕гр╕Б (Excess): [р╕гр╕░р╕Ър╕╕] р╕Ър╕▓р╕Ч [р╕лр╕Щр╣Йр╕▓ 1]
          тАв р╣Ар╕Ър╕нр╕гр╣Мр╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕: [р╕гр╕░р╕Ър╕╕р╣Ар╕Ър╕нр╕гр╣Мр╕Чр╕╡р╣Ир╣Ар╕Ир╕нр╣Гр╕Щр╣Ар╕нр╕Бр╕кр╕▓р╕г р╣Ар╕Кр╣Ир╕Щ 1557] [р╕лр╕Щр╣Йр╕▓ 1]

          ЁЯФН **р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╕Ир╕▓р╕Бр╕ар╕▓р╕Ю**
          тАв р╕Юр╕Ър╕гр╕нр╕вр╕Чр╕╡р╣И: [р╕гр╕░р╕Ър╕╕р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З р╣Ар╕Кр╣Ир╕Щ р╕Ыр╕гр╕░р╕Хр╕╣р╕Лр╣Йр╕▓р╕в]
          тАв р╕ер╕▒р╕Бр╕йр╕Ур╕░: [р╣Ар╕Кр╣Ир╕Щ р╕гр╕нр╕вр╕Вр╕╣р╕Фр╕ер╕╢р╕Бр╕Ир╕▓р╕Бр╕Бр╕▓р╕гр╣Ар╕Ър╕╡р╕вр╕Фр╕зр╕▒р╕Хр╕Цр╕╕]
          тАв р╕кр╕▓р╣Ар╕лр╕Хр╕╕: [р╣Ар╕Кр╣Ир╕Щ р╣Ар╕Йр╕╡р╣Ир╕вр╕зр╕Кр╕Щр╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╣Ар╕Ыр╣Зр╕Щр╕вр╕▓р╕Щр╕Юр╕▓р╕лр╕Щр╕░]

          тЪЦя╕П **р╕Ьр╕ер╕Бр╕▓р╕гр╕Юр╕┤р╕Ир╕▓р╕гр╕Ур╕▓р╕кр╕┤р╕Щр╣Др╕лр╕б**
          [р╣Ар╕ер╕╖р╕нр╕Бр╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╣Ар╕Юр╕╡р╕вр╕З 1 р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б:]

          тАв ЁЯЯв **р╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕б (р╣Бр╕Щр╕░р╕Щр╕│)** - р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╣Бр╕ер╕░р╕Др╣Ир╕▓р╕Лр╣Ир╕нр╕бр╕кр╕╣р╕Зр╕Бр╕зр╣Ир╕▓р╕Др╣Ир╕▓ Excess
          тАв ЁЯЯб **р╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕б (р╕бр╕╡р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в)** - р╣Ар╕Др╕ер╕бр╣Др╕Фр╣Йр╕Хр╕▓р╕бр╕кр╕┤р╕Чр╕Шр╕┤р╣М р╣Бр╕Хр╣Ир╕Др╣Ир╕▓р╕Лр╣Ир╕нр╕бр╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╕Хр╣Ир╕│р╕Бр╕зр╣Ир╕▓р╕Др╣Ир╕▓ Excess р╕Чр╣Ир╕▓р╕Щр╕Хр╣Йр╕нр╕Зр╕гр╕▒р╕Ър╕Ьр╕┤р╕Фр╕Кр╕нр╕Ър╣Ар╕нр╕З
          тАв ЁЯФ┤ **р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Др╕ер╕бр╣Др╕Фр╣Й** - р╕гр╕нр╕вр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╣Др╕бр╣Ир╕Хр╕гр╕Зр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В (р╣Ар╕Кр╣Ир╕Щ р╕Кр╕▒р╣Йр╕Щ 2+ р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╣Ар╕Ыр╣Зр╕Щр╕вр╕▓р╕Щр╕Юр╕▓р╕лр╕Щр╕░)

          тАв **р╣Ар╕лр╕Хр╕╕р╕Ьр╕е:** [р╕нр╕Шр╕┤р╕Ър╕▓р╕вр╕кр╕▒р╣Йр╕Щр╣Ж р╣Вр╕Фр╕вр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Ыр╕гр╕░р╕Бр╕▒р╕Щ [р╕лр╕Щр╣Йр╕▓ 1] р╣Ар╕Чр╕╡р╕вр╕Ър╕Бр╕▒р╕Ър╕ер╕▒р╕Бр╕йр╕Ур╕░р╕гр╕нр╕вр╣Гр╕Щр╕ар╕▓р╕Ю]

          ЁЯТ░ **р╕кр╕гр╕╕р╕Ыр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щ**
          тАв р╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╕Др╣Ир╕▓р╕Лр╣Ир╕нр╕б: [р╕Кр╣Ир╕зр╕Зр╕гр╕▓р╕Др╕▓] р╕Ър╕▓р╕Ч
          тАв р╕Др╕╕р╕Ур╕Ир╣Ир╕▓р╕вр╣Ар╕нр╕З (Excess): [р╕гр╕░р╕Ър╕╕] р╕Ър╕▓р╕Ч [р╕лр╕Щр╣Йр╕▓ 1]
          тАв р╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕гр╕▒р╕Ър╕Ьр╕┤р╕Фр╕Кр╕нр╕Ъ: [р╕гр╕░р╕Ър╕╕] р╕Ър╕▓р╕Ч

          ЁЯУЛ **3 р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Фр╣Ир╕зр╕Щ**
          1. **р╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕р╕Чр╕▒р╕Щр╕Чр╕╡:** р╣Вр╕Чр╕г [р╣Ар╕Ър╕нр╕гр╣Мр╕Ир╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕г]
          2. **р╕Щр╕▒р╕Фр╕Хр╕гр╕зр╕Ир╕кр╕ар╕▓р╕Ю:** р╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Гр╕Ър╕Вр╕▒р╕Ър╕Вр╕╡р╣Ир╣Бр╕ер╕░р╕ар╕▓р╕Юр╕Цр╣Ир╕▓р╕вр╕Щр╕╡р╣Йр╣Др╕зр╣Йр╣Гр╕лр╣Йр╣Ар╕Ир╣Йр╕▓р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И
          3. **р╣Ар╕Вр╣Йр╕▓р╕Лр╣Ир╕нр╕б:** р╕Щр╕│р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕нр╕╣р╣Ир╣Ар╕Др╕гр╕╖р╕н [р╕гр╕░р╕Ър╕╕р╕Кр╕╖р╣Ир╕нр╕Ър╕гр╕┤р╕йр╕▒р╕Чр╕Ыр╕гр╕░р╕Бр╕▒р╕Щ]

          тЪая╕П **р╕Вр╣Йр╕нр╣Бр╕Щр╕░р╕Щр╕│р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б:** [р╣Ар╕Кр╣Ир╕Щ р╕Бр╕гр╕Ур╕╡р╕Др╣Ир╕▓р╕Лр╣Ир╕нр╕бр╣Гр╕Бр╕ер╣Йр╣Ар╕Др╕╡р╕вр╕З Excess р╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╕Лр╣Ир╕нр╕бр╣Ар╕нр╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Бр╕йр╕▓р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕ер╕Фр╣Ар╕Ър╕╡р╣Йр╕вр╕Ыр╕╡р╕лр╕Щр╣Йр╕▓]

          *р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щр╣Вр╕Фр╕в AI р╕Ир╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Чр╕╡р╣Ир╕гр╕░р╕Ър╕╕ р╣Вр╕Ыр╕гр╕Фр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▒р╕Ър╕Ър╕гр╕┤р╕йр╕▒р╕Чр╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З*
          """
        else:
            # р╕Бр╕гр╕Ур╕╡р╣Др╕бр╣Ир╕бр╕╡р╣Ар╕нр╕Бр╕кр╕▓р╕г - р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ
            return "тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М\n\nр╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Ар╕Ир╣Йр╕▓р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╣Ар╕Юр╕╖р╣Ир╕нр╕нр╕▒р╕Юр╣Вр╕лр╕ер╕Фр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╕ер╕Зр╕гр╕░р╕Ър╕Ър╕Бр╣Ир╕нр╕Щр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ"

        # р╣Бр╕Ыр╕ер╕Зр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╣Ар╕Ыр╣Зр╕Щ PIL Image
        from PIL import Image
        
        damage_image = Image.open(io.BytesIO(image_bytes))
        
        # р╣Бр╕Ыр╕ер╕Зр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╕Ир╕▓р╕Б Base64
        policy_doc_base64 = policy_info['policy_document_base64']
        policy_doc_bytes = base64.b64decode(policy_doc_base64)
        
        print(f"ЁЯУД р╕кр╣Ир╕Зр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М (PDF) р╣Бр╕ер╕░р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╣Др╕Ыр╣Гр╕лр╣Й AI р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣М")
        
        # р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б PDF р╕ер╕Зр╣Др╕Яр╕ер╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕░р╕з (Gemini р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г file path р╕кр╕│р╕лр╕гр╕▒р╕Ъ PDF)
        with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as temp_pdf:
            temp_pdf.write(policy_doc_bytes)
            temp_pdf_path = temp_pdf.name
        
        try:
            # р╕нр╕▒р╕Юр╣Вр╕лр╕ер╕Ф PDF р╣Др╕Ыр╕вр╕▒р╕З Gemini
            uploaded_pdf = genai.upload_file(temp_pdf_path, mime_type="application/pdf")
            print(f"тЬЕ р╕нр╕▒р╕Юр╣Вр╕лр╕ер╕Ф PDF р╕кр╕│р╣Ар╕гр╣Зр╕И: {uploaded_pdf.name}")
            
            # р╕гр╕нр╣Гр╕лр╣Й Gemini р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Др╕Яр╕ер╣Мр╣Ар╕кр╕гр╣Зр╕И
            time.sleep(2)
            print(f"тП│ р╕гр╕н Gemini р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е PDF...")
            
            # р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Й Gemini API - р╕кр╣Ир╕Зр╕Чр╕▒р╣Йр╕Зр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕вр╣Бр╕ер╕░р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М
            response = gemini_model.generate_content([
                system_prompt,
                damage_image,      # р╕гр╕╣р╕Ыр╕Чр╕╡р╣И 1: р╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╕вр╕лр╕▓р╕в
                uploaded_pdf       # р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М (PDF)
            ])
            
            # р╕ер╕Ър╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕нр╕▒р╕Юр╣Вр╕лр╕ер╕Фр╕нр╕нр╕Бр╕Ир╕▓р╕Б Gemini
            genai.delete_file(uploaded_pdf.name)
            print(f"ЁЯЧСя╕П р╕ер╕Ър╣Др╕Яр╕ер╣М PDF р╕Ир╕▓р╕Б Gemini р╣Бр╕ер╣Йр╕з")
            
        finally:
            # р╕ер╕Ър╣Др╕Яр╕ер╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕░
            if os.path.exists(temp_pdf_path):
                os.unlink(temp_pdf_path)
                print(f"ЁЯЧСя╕П р╕ер╕Ър╣Др╕Яр╕ер╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕░р╣Бр╕ер╣Йр╕з")

        return response.text

    except Exception as e:
        error_msg = f"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю: {str(e)}"
        print(f"Gemini API Error: {error_msg}")
        import traceback
        traceback.print_exc()
        return f"тЭМ {error_msg}\n\nр╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З р╕лр╕гр╕╖р╕нр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Ар╕Ир╣Йр╕▓р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И"


# ==================== LINE Bot Handlers ====================
@handler.add(MessageEvent, message=TextMessageContent)
def handle_text_message(event):
    """
    р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕гр╕Ир╕▓р╕Б LINE
    """
    user_id = event.source.user_id
    text = event.message.text.strip()

    with ApiClient(configuration) as api_client:
        line_bot_api = MessagingApi(api_client)

        try:
            # Case 1: р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣М
            if text == "р╣Ар╕Кр╣Зр╕Др╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕бр╕Фр╣Ир╕зр╕Щ":
                # р╕гр╕╡р╣Ар╕Лр╣Зр╕Х session
                user_sessions[user_id] = {"state": "waiting_for_info"}

                # р╕кр╣Ир╕З Flex Message р╕Вр╕нр╕Вр╣Йр╕нр╕бр╕╣р╕е
                flex_message = create_request_info_flex()
                line_bot_api.reply_message(
                    ReplyMessageRequest(
                        reply_token=event.reply_token,
                        messages=[FlexMessage(alt_text="р╕Бр╕гр╕╕р╕Ур╕▓р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Кр╕╖р╣Ир╕нр╣Бр╕ер╕░р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕гр╕Ц", contents=flex_message)]
                    )
                )
                return

            # Case 2: р╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Кр╕╖р╣Ир╕нр╣Бр╕ер╕░р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕гр╕Ц
            if user_id in user_sessions and user_sessions[user_id].get("state") == "waiting_for_info":
                # р╣Бр╕вр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е (р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ: "р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е, р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕гр╕Ц" р╕лр╕гр╕╖р╕н "р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е, р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕гр╕Ц, р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф")
                parts = [part.strip() for part in text.split(",")]

                if len(parts) < 2 or len(parts) > 3:
                    line_bot_api.reply_message(
                        ReplyMessageRequest(
                            reply_token=event.reply_token,
                            messages=[TextMessage(text="тЭМ р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З\n\nЁЯУЭ р╕Бр╕гр╕╕р╕Ур╕▓р╕кр╣Ир╕Зр╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ:\nр╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е, р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕гр╕Ц, р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф (optional)\n\nтЬЕ р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З:\nтАв р╕кр╕бр╕Кр╕▓р╕в р╣Ар╕Вр╣Зр╕бр╕Бр╕ер╕▒р╕Ф, 1р╕Бр╕В1234\nтАв р╕кр╕бр╕Кр╕▓р╕в р╣Ар╕Вр╣Зр╕бр╕Бр╕ер╕▒р╕Ф, 1р╕Бр╕В1234, р╕Кр╕Щр╣Ар╕кр╕▓р╕лр╕Щр╣Йр╕▓р╕гр╕Ц")]
                        )
                    )
                    return

                name = parts[0]
                plate = parts[1]
                additional_info = parts[2] if len(parts) == 3 else None

                # р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Кр╕▒р╣Ир╕зр╕Др╕гр╕▓р╕з р╣Бр╕ер╕░р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ state р╣Ар╕Ыр╣Зр╕Щ "waiting_for_counterpart"
                user_sessions[user_id] = {
                    "state": "waiting_for_counterpart",
                    "name": name,
                    "plate": plate,
                    "additional_info": additional_info
                }

                # р╕кр╣Ир╕Зр╕Др╕│р╕Цр╕▓р╕бр╕Юр╕гр╣Йр╕нр╕б Quick Reply Buttons (2 р╕Ыр╕╕р╣Ир╕б: р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡ / р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡)
                quick_reply = QuickReply(items=[
                    QuickReplyItem(action=MessageAction(
                        label="тЬЕ р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡", 
                        text="р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡"
                    )),
                    QuickReplyItem(action=MessageAction(
                        label="тЭМ р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡", 
                        text="р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡"
                    ))
                ])

                additional_text = f"\nр╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф: {additional_info}" if additional_info else ""
                
                line_bot_api.reply_message(
                    ReplyMessageRequest(
                        reply_token=event.reply_token,
                        messages=[TextMessage(
                            text=f"ЁЯУЛ р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щ:\n\nр╕Кр╕╖р╣Ир╕н: {name}\nр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щ: {plate}{additional_text}\n\nтЭУ **р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡р╕лр╕гр╕╖р╕нр╣Др╕бр╣И?**\n\nр╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Б:",
                            quick_reply=quick_reply
                        )]
                    )
                )
                return

            # Case 2.5: р╕гр╕▒р╕Ър╕Др╕│р╕Хр╕нр╕Ър╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡
            if user_id in user_sessions and user_sessions[user_id].get("state") == "waiting_for_counterpart":
                
                # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕│р╕Хр╕нр╕Ъ
                if text in ["р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡", "р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡"]:
                    has_counterpart = text
                    
                    # р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Ар╕Бр╣Зр╕Ър╣Др╕зр╣Йр╕Ир╕▓р╕Б session
                    name = user_sessions[user_id]["name"]
                    plate = user_sessions[user_id]["plate"]
                    additional_info = user_sessions[user_id].get("additional_info")
                    
                    # р╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М (р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕Др╣Ир╕нр╕вр╕Др╣Йр╕Щр╕лр╕▓!)
                    policy_info = get_policy_info(name, plate)
                    
                    if not policy_info:
                        line_bot_api.reply_message(
                            ReplyMessageRequest(
                                reply_token=event.reply_token,
                                messages=[TextMessage(
                                    text=f"тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М\n\nр╕Кр╕╖р╣Ир╕н: {name}\nр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕гр╕Ц: {plate}\n\nр╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З р╕лр╕гр╕╖р╕нр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Ар╕Ир╣Йр╕▓р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И"
                                )]
                            )
                        )
                        # р╕гр╕╡р╣Ар╕Лр╣Зр╕Х state
                        user_sessions[user_id] = {"state": "waiting_for_info"}
                        return
                    
                    # р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щр╣Гр╕Щ session
                    user_sessions[user_id] = {
                        "state": "waiting_for_image",
                        "name": name,
                        "plate": plate,
                        "additional_info": additional_info,
                        "has_counterpart": has_counterpart,  # р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡
                        "policy_info": policy_info
                    }
                    
                    # р╕кр╣Ир╕З Flex Message р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╣Бр╕ер╕░р╕Вр╕нр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю
                    flex_message = create_policy_info_flex(policy_info)
                    line_bot_api.reply_message(
                        ReplyMessageRequest(
                            reply_token=event.reply_token,
                            messages=[FlexMessage(
                                alt_text="р╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М р╕Бр╕гр╕╕р╕Ур╕▓р╕кр╣Ир╕Зр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю", 
                                contents=flex_message
                            )]
                        )
                    )
                    return
                
                else:
                    # р╕Др╕│р╕Хр╕нр╕Ър╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
                    quick_reply = QuickReply(items=[
                        QuickReplyItem(action=MessageAction(
                            label="тЬЕ р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡", 
                            text="р╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡"
                        )),
                        QuickReplyItem(action=MessageAction(
                            label="тЭМ р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡", 
                            text="р╣Др╕бр╣Ир╕бр╕╡р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡"
                        ))
                    ])
                    
                    line_bot_api.reply_message(
                        ReplyMessageRequest(
                            reply_token=event.reply_token,
                            messages=[TextMessage(
                                text="тЭМ р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Ир╕▓р╕Бр╕Ыр╕╕р╣Ир╕бр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕З:",
                                quick_reply=quick_reply
                            )]
                        )
                    )
                    return

            # Case 3: р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕▒р╣Ир╕зр╣Др╕Ы (р╣Др╕бр╣Ир╕нр╕вр╕╣р╣Ир╣Гр╕Щ flow)
            line_bot_api.reply_message(
                ReplyMessageRequest(
                    reply_token=event.reply_token,
                    messages=[TextMessage(text='ЁЯСЛ р╕кр╕зр╕▒р╕кр╕Фр╕╡р╕Др╣Ир╕░!\n\nр╕кр╣Ир╕З "р╣Ар╕Кр╣Зр╕Др╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕бр╕Фр╣Ир╕зр╕Щ" р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Бр╕▓р╕гр╣Ар╕Др╕ер╕бр╕Ыр╕гр╕░р╕Бр╕▒р╕Щр╕гр╕Цр╕вр╕Щр╕Хр╣М')]
                )
            )

        except Exception as e:
            print(f"Error handling text message: {str(e)}")
            line_bot_api.reply_message(
                ReplyMessageRequest(
                    reply_token=event.reply_token,
                    messages=[TextMessage(text="тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З")]
                )
            )


@handler.add(MessageEvent, message=ImageMessageContent)
def handle_image_message(event):
    """
    р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Ир╕▓р╕Б LINE р╣Бр╕ер╕░р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Фр╣Йр╕зр╕в Gemini AI
    """
    user_id = event.source.user_id

    with ApiClient(configuration) as api_client:
        line_bot_api = MessagingApi(api_client)

        try:
            # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕гр╕нр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
            if user_id not in user_sessions or user_sessions[user_id].get("state") != "waiting_for_image":
                line_bot_api.reply_message(
                    ReplyMessageRequest(
                        reply_token=event.reply_token,
                        messages=[TextMessage(text='тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕кр╣Ир╕З "р╣Ар╕Кр╣Зр╕Др╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕бр╕Фр╣Ир╕зр╕Щ" р╣Бр╕ер╕░р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╣Ир╕нр╕Щр╕кр╣Ир╕Зр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Др╣Ир╕░')]
                    )
                )
                return

            # р╣Бр╕Ир╣Йр╕Зр╕зр╣Ир╕▓р╕Бр╕│р╕ер╕▒р╕Зр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е
            line_bot_api.reply_message(
                ReplyMessageRequest(
                    reply_token=event.reply_token,
                    messages=[TextMessage(text="тП│ р╕Бр╕│р╕ер╕▒р╕Зр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю...\n\nр╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕нр╕кр╕▒р╕Бр╕Др╕гр╕╣р╣Ир╕Др╣Ир╕░ (р╕Ыр╕гр╕░р╕бр╕▓р╕У 10-30 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡)")]
                )
            )

            print(f"ЁЯФН р╣Ар╕гр╕┤р╣Ир╕бр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕кр╕│р╕лр╕гр╕▒р╕Ъ user: {user_id}")
            
            # р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Ир╕▓р╕Б LINE
            message_id = event.message.id
            image_url = f"https://api-data.line.me/v2/bot/message/{message_id}/content"
            headers = {"Authorization": f"Bearer {LINE_CHANNEL_ACCESS_TOKEN}"}

            print(f"ЁЯУе р╕Бр╕│р╕ер╕▒р╕Зр╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю...")
            with httpx.Client() as client:
                response = client.get(image_url, headers=headers)
                response.raise_for_status()
                image_bytes = response.content
            
            print(f"тЬЕ р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕кр╕│р╣Ар╕гр╣Зр╕И: {len(image_bytes)} bytes")

            # р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣Мр╕Ир╕▓р╕Б session
            policy_info = user_sessions[user_id]["policy_info"]
            additional_info = user_sessions[user_id].get("additional_info")
            has_counterpart = user_sessions[user_id].get("has_counterpart")
            
            print(f"ЁЯУЛ р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕гр╕бр╕Шр╕гр╕гр╕бр╣М: {policy_info['policy_number']}")
            print(f"ЁЯУЭ р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б: {additional_info if additional_info else 'р╣Др╕бр╣Ир╕бр╕╡'}")
            print(f"ЁЯСе р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡: {has_counterpart if has_counterpart else 'р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕'}")

            # р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Фр╣Йр╕зр╕в Gemini AI (р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕бр╣Бр╕ер╕░р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕╣р╣Ир╕Бр╕гр╕Ур╕╡)
            print(f"ЁЯдЦ р╕Бр╕│р╕ер╕▒р╕Зр╕кр╣Ир╕Зр╣Др╕Ыр╕вр╕▒р╕З Gemini AI...")
            
            analysis_result = analyze_damage_with_gemini(
                image_bytes, 
                policy_info, 
                additional_info, 
                has_counterpart
            )
            
            print(f"тЬЕ Gemini AI р╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Бр╕ер╣Йр╕з")
            print(f"ЁЯУЭ р╕Ьр╕ер╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣М: {analysis_result[:100]}...")

            # р╕Фр╕╢р╕Зр╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕гр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б AI
            phone_number = extract_phone_from_response(analysis_result)
            print(f"ЁЯУЮ р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕гр╕Чр╕╡р╣Ир╕Фр╕╢р╕Зр╣Др╕Фр╣Й: {phone_number if phone_number else 'р╣Др╕бр╣Ир╕Юр╕Ъ'}")

            # р╕кр╣Ир╕Зр╕Ьр╕ер╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕вр╕▒р╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Юр╕гр╣Йр╕нр╕бр╕Ыр╕╕р╣Ир╕бр╣Вр╕Чр╕гр╕нр╕нр╕Б
            if phone_number:
                # р╕кр╕гр╣Йр╕▓р╕З Flex Message р╕Юр╕гр╣Йр╕нр╕бр╕Ыр╕╕р╣Ир╕бр╣Вр╕Чр╕гр╕нр╕нр╕Б
                flex_message = create_analysis_result_flex(
                    summary_text=analysis_result,
                    phone_number=phone_number,
                    insurance_company=policy_info.get('insurance_company', ''),
                    claim_status="unknown"  # р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ыр╕гр╕▒р╕Ър╣Гр╕лр╣Й AI р╕кр╣Ир╕З status р╕бр╕▓р╣Др╕Фр╣Й
                )
                
                line_bot_api.push_message(
                    PushMessageRequest(
                        to=user_id,
                        messages=[FlexMessage(
                            alt_text="р╕Ьр╕ер╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Ар╕Др╕ер╕бр╕Ыр╕гр╕░р╕Бр╕▒р╕Щ",
                            contents=flex_message
                        )]
                    )
                )
                print(f"тЬЕ р╕кр╣Ир╕Зр╕Ьр╕ер╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Юр╕гр╣Йр╕нр╕бр╕Ыр╕╕р╣Ир╕бр╣Вр╕Чр╕г {phone_number}")
            else:
                # р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г тЖТ р╕кр╣Ир╕Зр╣Ар╕Ыр╣Зр╕Щ Text р╕Шр╕гр╕гр╕бр╕Фр╕▓ + р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ыр╕┤р╕Фр╕Чр╣Йр╕▓р╕в
                line_bot_api.push_message(
                    PushMessageRequest(
                        to=user_id,
                        messages=[TextMessage(text=analysis_result)]
                    )
                )
                print(f"тЬЕ р╕кр╣Ир╕Зр╕Ьр╕ер╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Бр╕Ър╕Ъ Text (р╣Др╕бр╣Ир╕Юр╕Ър╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г)")
                
                # р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ыр╕┤р╕Фр╕Чр╣Йр╕▓р╕в
                line_bot_api.push_message(
                    PushMessageRequest(
                        to=user_id,
                        messages=[TextMessage(text='тЬЕ р╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М\n\nр╕лр╕▓р╕Бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕гр╕Цр╕Др╕▒р╕Щр╕нр╕╖р╣Ир╕Щ р╕Бр╕гр╕╕р╕Ур╕▓р╕кр╣Ир╕З "р╣Ар╕Кр╣Зр╕Др╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Др╕ер╕бр╕Фр╣Ир╕зр╕Щ" р╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Др╣Ир╕░')]
                    )
                )

            # р╕гр╕╡р╣Ар╕Лр╣Зр╕Х session р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ
            user_sessions[user_id] = {"state": "completed"}

        except httpx.HTTPStatusError as e:
            print(f"тЭМ Error downloading image: {str(e)}")
            line_bot_api.push_message(
                PushMessageRequest(
                    to=user_id,
                    messages=[TextMessage(text="тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Др╕Фр╣Й р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З")]
                )
            )
        except Exception as e:
            print(f"тЭМ Error handling image message: {str(e)}")
            import traceback
            traceback.print_exc()
            
            line_bot_api.push_message(
                PushMessageRequest(
                    to=user_id,
                    messages=[TextMessage(text=f"тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: {str(e)}\n\nр╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З р╕лр╕гр╕╖р╕нр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Ар╕Ир╣Йр╕▓р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И")]
                )
            )


# ==================== FastAPI Endpoints ====================
@app.get("/")
async def root():
    """
    Endpoint р╕лр╕ер╕▒р╕Бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ API р╕Чр╕│р╕Зр╕▓р╕Щр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    """
    return {
        "message": "LINE Insurance Claim Bot API",
        "status": "running",
        "version": "1.0.0"
    }


@app.post("/webhook")
async def webhook(request: Request):
    """
    Webhook Endpoint р╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕▓р╕Б LINE Platform
    """
    # р╕Фр╕╢р╕З signature р╕Ир╕▓р╕Б header р╣Ар╕Юр╕╖р╣Ир╕н verify р╕зр╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щ request р╕Ир╕▓р╕Б LINE р╕Ир╕гр╕┤р╕З
    signature = request.headers.get("X-Line-Signature")

    if not signature:
        raise HTTPException(status_code=400, detail="X-Line-Signature header is missing")

    # р╕Фр╕╢р╕З body р╕Вр╕нр╕З request
    body = await request.body()
    body_text = body.decode("utf-8")

    try:
        # р╣Гр╕Кр╣Й handler р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е events
        handler.handle(body_text, signature)
    except InvalidSignatureError:
        raise HTTPException(status_code=400, detail="Invalid signature")
    except Exception as e:
        print(f"Webhook error: {str(e)}")
        raise HTTPException(status_code=500, detail="Internal server error")

    return JSONResponse(content={"status": "ok"})


@app.get("/health")
async def health_check():
    """
    Health Check Endpoint р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░р╕Вр╕нр╕З API
    """
    return {
        "status": "healthy",
        "line_configured": bool(LINE_CHANNEL_ACCESS_TOKEN and LINE_CHANNEL_SECRET),
        "gemini_configured": bool(GEMINI_API_KEY)
    }


# ==================== Main ====================
if __name__ == "__main__":
    import uvicorn
    import os
    port = int(os.getenv("PORT", 8000))

    try:
        # р╕Чр╕Фр╕кр╕нр╕Ър╕Фр╕╢р╕Зр╕Кр╕╖р╣Ир╕нр╣Вр╕бр╣Ар╕Фр╕ер╕Чр╕╡р╣И Key р╕Щр╕╡р╣Йр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕Фр╣Й
        available_models = [m.name for m in genai.list_models()]
        print(f"тЬЕ API Key р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И р╣Вр╕бр╣Ар╕Фр╕ер╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Др╕Фр╣Й: {available_models[:3]}")
    except Exception as e:
        print(f"тЭМ API Key р╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓: {e}")

    # р╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╕зр╣Ир╕▓р╕Чр╕│р╕Зр╕▓р╕Щр╣Гр╕Щ GitHub Codespaces р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    codespace_name = os.getenv("CODESPACE_NAME")
    github_codespaces_port_forwarding_domain = os.getenv("GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN")
    
    print("\n" + "=" * 70)
    
    if codespace_name and github_codespaces_port_forwarding_domain:
        # р╕Чр╕│р╕Зр╕▓р╕Щр╣Гр╕Щ GitHub Codespaces
        public_url = f"https://{codespace_name}-{port}.{github_codespaces_port_forwarding_domain}"
        webhook_url = f"{public_url}/webhook"
        
        print("ЁЯОЙ GitHub Codespaces - LINE Insurance Claim Bot")
        print("=" * 70)
        print(f"ЁЯУН Local Server: http://localhost:{port}")
        print(f"ЁЯМР Public URL: {public_url}")
        print(f"ЁЯФЧ Webhook URL: {webhook_url}")
        print(f"тЭдя╕П  Health Check: {public_url}/health")
        print("=" * 70)
        print("\nЁЯУЛ р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ LINE Webhook:")
        print("   1. р╣Др╕Ыр╕Чр╕╡р╣И: https://developers.line.biz/console/")
        print("   2. р╣Ар╕ер╕╖р╕нр╕Б Channel р╕Вр╕нр╕Зр╕Др╕╕р╕У")
        print("   3. р╣Др╕Ыр╕Чр╕╡р╣И: Messaging API > Webhook settings")
        print(f"   4. р╕зр╕▓р╕З URL: {webhook_url}")
        print("   5. р╕Бр╕Ф 'Update' р╣Бр╕ер╕░ 'Verify' тЖТ р╕Хр╣Йр╕нр╕Зр╣Др╕Фр╣Й тЬЕ Success")
        print("   6. р╣Ар╕Ыр╕┤р╕Ф 'Use webhook' = ON")
        print("=" * 70)
        print("\nтЪая╕П  р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕р╕кр╕│р╕Др╕▒р╕Н:")
        print("   тАв р╣Гр╕Щ Codespaces Ports tab р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Port Visibility = 'Public'")
        print("   тАв р╕Цр╣Йр╕▓ Port р╣Ар╕Ыр╣Зр╕Щ 'Private' р╣Гр╕лр╣Йр╕Др╕ер╕┤р╕Бр╕Вр╕зр╕▓р╕Чр╕╡р╣И Port > Port Visibility > Public")
        print("   тАв Webhook URL р╕Ир╕░р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╕Чр╕▒р╕Щр╕Чр╕╡р╕лр╕ер╕▒р╕З Server р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕│р╕Зр╕▓р╕Щ")
        print("=" * 70 + "\n")
    else:
        # р╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕Ър╕Ъ Local р╕лр╕гр╕╖р╕н Cloud р╕нр╕╖р╣Ир╕Щр╣Ж
        print("ЁЯЪА LINE Insurance Claim Bot (Local/Cloud Mode)")
        print("=" * 70)
        print(f"ЁЯУН Local Server: http://localhost:{port}")
        print(f"ЁЯФЧ Local Webhook: http://localhost:{port}/webhook")
        print(f"тЭдя╕П  Health Check: http://localhost:{port}/health")
        print("=" * 70)
        print("\nтЪая╕П  р╕кр╕│р╕Др╕▒р╕Н! р╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Й Tunnel Service р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ LINE:")
        print("\n   ЁЯФ╕ р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Бр╕Чр╕╡р╣И 1: Cloudflare Tunnel")
        print(f"      Terminal р╕нр╕╖р╣Ир╕Щ: ./start_cloudflare.sh")
        print(f"      р╕лр╕гр╕╖р╕н: cloudflared tunnel --url http://localhost:{port}")
        print("\n   ЁЯФ╕ р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Бр╕Чр╕╡р╣И 2: ngrok")
        print(f"      Terminal р╕нр╕╖р╣Ир╕Щ: ngrok http {port}")
        print("\n   ЁЯФ╕ р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Бр╕Чр╕╡р╣И 3: GitHub Codespaces (р╣Бр╕Щр╕░р╕Щр╕│)")
        print("      р╣Ар╕Ыр╕┤р╕Фр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╣Гр╕Щ GitHub Codespaces р╕Ир╕░р╣Др╕Фр╣Й Public URL р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤")
        print("=" * 70 + "\n")

    # р╕гр╕▒р╕Щ uvicorn server
    uvicorn.run(app, host="0.0.0.0", port=port)

